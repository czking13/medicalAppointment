<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>瑞安老中医问诊预约</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
    h1 { color: #333; }
    .calendar, .time-slots, .form-container, .appointment-table {
      margin: 20px auto; width: 90%; max-width: 600px; border: 1px solid #ccc; border-radius: 10px; padding: 10px; }
    .calendar table { width: 100%; border-collapse: collapse; }
    .calendar th, .calendar td { padding: 10px; text-align: center; border: 1px solid #ddd; }
    .calendar th { background-color: #f4f4f4; }
    .calendar td.weekend { background-color: #f9ecec; }
    .calendar td.workday { background-color: #ecf9ec; }
    .calendar td.disabled { color: #bbb; pointer-events: none; }
    .time-slots button {
      padding: 5px 10px; margin: 5px; background-color: #007BFF; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .time-slots button.selected { background-color: #FFD700; } /* Highlighted color */
    .time-slots button.disabled { background-color: #ccc; cursor: not-allowed; }
    .form-container { display: none; }
    .form-container input, .form-container select, .form-container textarea {
      display: block; width: 100%; margin-top: 5px; }
    .form-group {
      margin-bottom: 15px;
      text-align: left;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .error-message {
      color: red;
      font-size: 12px;
      margin-top: 5px;
      display: none;
    }
    .invalid-input {
      border: 1px solid red;
    }
    .calendar td.selected {
      background-color: #FFD700; /* 选中日期的背景色 */
      font-weight: bold;
    }
    .time-slots button.selected {
      background-color: #FFD700; /* 选中时间段的背景色 */
      color: #000;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>瑞安老中医问诊预约</h1>
  <div class="month-display" id="month-display"></div>
  <div class="calendar">
    <table>
      <thead>
        <tr><th>周日</th><th>周一</th><th>周二</th><th>周三</th><th>周四</th><th>周五</th><th>周六</th></tr>
      </thead>
      <tbody id="calendar-body">
        <!-- Calendar content will be dynamically generated here -->
      </tbody>
    </table>
  </div>
  <div class="time-slots" id="time-slots">
    <h3>请选择日期查看可预约时间段</h3>
  </div>
  <div class="form-container" id="form-container">
    <h3>填写预约信息</h3>
    <form id="appointment-form">
      <div class="form-group">
        <label>预约时间:</label>
        <span id="selected-time"></span>
      </div>

      <div class="form-group">
        <label for="name">姓名:</label>
        <input type="text" id="name" name="name" required>
      </div>

      <div class="form-group">
        <label for="gender">性别:</label>
        <select id="gender" name="gender" required>
          <option value="">请选择性别</option>
          <option value="男">男</option>
          <option value="女">女</option>
        </select>
      </div>

      <div class="form-group">
        <label for="age">年龄（虚岁）:</label>
        <input type="number" id="age" name="age" required min="1" max="120">
      </div>

      <div class="form-group">
        <label for="zodiac">生肖:</label>
        <select id="zodiac" name="zodiac" required>
          <option value="">请选择生肖</option>
          <option value="鼠">鼠</option>
          <option value="牛">牛</option>
          <option value="虎">虎</option>
          <option value="兔">兔</option>
          <option value="龙">龙</option>
          <option value="蛇">蛇</option>
          <option value="马">马</option>
          <option value="羊">羊</option>
          <option value="猴">猴</option>
          <option value="鸡">鸡</option>
          <option value="狗">狗</option>
          <option value="猪">猪</option>
        </select>
      </div>

      <div class="form-group">
        <label for="phone">电话:</label>
        <input type="tel" id="phone" name="phone" required>
        <div id="phone-error" class="error-message">请输入正确的11位手机号码</div>
      </div>

      <div class="form-group">
        <label for="address">常住地址:</label>
        <input type="text" id="address" name="address" required>
      </div>

      <div class="form-group">
        <label for="symptoms">症状:</label>
        <textarea id="symptoms" name="symptoms" required></textarea>
      </div>

      <div class="form-group">
        <label>是否在吃西药：</label>
        <input type="radio" id="western-medicine-yes" name="western-medicine" value="是" required>
        <label for="western-medicine-yes">是</label>
        <input type="radio" id="western-medicine-no" name="western-medicine" value="否" required>
        <label for="western-medicine-no">否</label>
      </div>

      <div class="form-group" id="medicine-details-group" style="display: none;">
        <label for="medicine-details">哪方面的药:</label>
        <input type="text" id="medicine-details" name="medicine-details">
      </div>

      <div class="form-group">
        <label>是否做过手术：</label>
        <input type="radio" id="surgery-yes" name="surgery" value="是" required>
        <label for="surgery-yes">是</label>
        <input type="radio" id="surgery-no" name="surgery" value="否" required>
        <label for="surgery-no">否</label>
      </div>

      <div class="form-group" id="surgery-details-group" style="display: none;">
        <label for="surgery-details">什么手术:</label>
        <input type="text" id="surgery-details" name="surgery-details">
      </div>

      <div class="form-group">
        <label for="num-people">预约人数:</label>
        <input type="number" id="num-people" name="num-people" min="1" max="2" value="1" required>
      </div>

      <button type="submit">提交预约</button>
    </form>
  </div>
  <script>
    const today = new Date();
    const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
    const workDays = [1, 2, 6, 0]; // Including weekends for testing
    const maxAppointments = 25;
    const timeSlotInterval = 5; // Interval in minutes

    let selectedDate = null;
    let selectedTimeSlot = null;

    function generateCalendar(monthDate) {
      const year = monthDate.getFullYear();
      const month = monthDate.getMonth();
      const firstDayOfWeek = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const calendarBody = document.getElementById("calendar-body");
      const monthDisplay = document.getElementById("month-display");
      monthDisplay.textContent = `${year}年${month + 1}月预约日历`;
      calendarBody.innerHTML = "";
      let day = 1;
      for (let i = 0; i < 6; i++) {
        const row = document.createElement("tr");
        for (let j = 0; j < 7; j++) {
          const cell = document.createElement("td");
          if (i === 0 && j < firstDayOfWeek) {
            cell.innerHTML = "";
          } else if (day > daysInMonth) {
            cell.innerHTML = "";
          } else {
            cell.innerHTML = day;
            const dayOfWeek = new Date(year, month, day).getDay();
            if (workDays.includes(dayOfWeek)) {
              cell.className = "workday";
              cell.addEventListener("click", () => toggleDateSelection(year, month, day, cell));
            } else {
              cell.className = "disabled";
            }
            day++;
          }
          row.appendChild(cell);
        }
        calendarBody.appendChild(row);
      }
    }

    function toggleDateSelection(year, month, day, cell) {
      const timeSlots = document.getElementById("time-slots");
      const formContainer = document.getElementById("form-container");
      
      if (selectedDate === `${year}-${month}-${day}`) {
        // 取消选择
        selectedDate = null;
        cell.classList.remove('selected');
        timeSlots.innerHTML = '<h3>请选择日期查看可预约时间段</h3>';
        formContainer.style.display = 'none';
        selectedTimeSlot = null;
      } else {
        // 新选择
        if (selectedDate) {
          // 移除之前选中日期的高亮
          document.querySelector('.calendar td.selected')?.classList.remove('selected');
        }
        selectedDate = `${year}-${month}-${day}`;
        cell.classList.add('selected');
        showTimeSlots(year, month, day);
      }
    }

    function showTimeSlots(year, month, day) {
      const timeSlots = document.getElementById("time-slots");
      timeSlots.innerHTML = `<h3>${year}年${month + 1}月${day}日 可预约时间段：</h3>`;
      const startTime = new Date(0, 0, 0, 9, 0);
      const endTime = new Date(0, 0, 0, 11, 30);
      let appointmentCount = 0;

      while (startTime <= endTime && appointmentCount < maxAppointments) {
        const timeString = `${startTime.getHours()}:${startTime.getMinutes().toString().padStart(2, '0')}`;
        const button = document.createElement('button');
        button.textContent = timeString;
        button.addEventListener("click", function(e) {
          toggleTimeSlotSelection(year, month, day, timeString, e.target);
        });
        timeSlots.appendChild(button);

        startTime.setMinutes(startTime.getMinutes() + timeSlotInterval);
        appointmentCount++;
      }
    }

    function toggleTimeSlotSelection(year, month, day, timeString, button) {
      const formContainer = document.getElementById("form-container");
      
      if (selectedTimeSlot === timeString) {
        // 取消选择
        selectedTimeSlot = null;
        button.classList.remove('selected');
        formContainer.style.display = 'none';
      } else {
        // 新选择
        if (selectedTimeSlot) {
          // 移除之前选中时间段的高亮
          document.querySelector('.time-slots button.selected')?.classList.remove('selected');
        }
        selectedTimeSlot = timeString;
        button.classList.add('selected');
        selectTimeSlot(year, month, day, timeString);
      }
    }

    function selectTimeSlot(year, month, day, timeString) {
      const formContainer = document.getElementById("form-container");
      document.getElementById("selected-time").textContent = `${year}年${month + 1}月${day}日 ${timeString}`;
      formContainer.style.display = "block";
    }

    document.addEventListener('DOMContentLoaded', function() {
      const westernMedicineRadios = document.querySelectorAll('input[name="western-medicine"]');
      const medicineDetails = document.getElementById('medicine-details-group');
      const surgeryRadios = document.querySelectorAll('input[name="surgery"]');
      const surgeryDetails = document.getElementById('surgery-details-group');

      westernMedicineRadios.forEach(radio => {
        radio.addEventListener('change', function() {
          medicineDetails.style.display = this.value === '是' ? 'block' : 'none';
          document.getElementById('medicine-details').required = this.value === '是';
        });
      });

      surgeryRadios.forEach(radio => {
        radio.addEventListener('change', function() {
          surgeryDetails.style.display = this.value === '是' ? 'block' : 'none';
          document.getElementById('surgery-details').required = this.value === '是';
        });
      });

      const phoneInput = document.getElementById('phone');
      const phoneError = document.getElementById('phone-error');
      
      phoneInput.addEventListener('input', function() {
        const phoneRegex = /^1[3-9]\d{9}$/;
        const isValid = phoneRegex.test(this.value);
        
        if (!isValid) {
          phoneError.style.display = 'block';
          this.classList.add('invalid-input');
        } else {
          phoneError.style.display = 'none';
          this.classList.remove('invalid-input');
        }
      });

      document.getElementById('appointment-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // 验证所有必填字段
        const requiredFields = this.querySelectorAll('[required]');
        let isValid = true;
        
        requiredFields.forEach(field => {
          if (!field.value) {
            isValid = false;
            field.classList.add('invalid-input');
            let errorDiv = field.nextElementSibling;
            if (!errorDiv || !errorDiv.classList.contains('error-message')) {
              errorDiv = document.createElement('div');
              errorDiv.className = 'error-message';
              field.parentNode.insertBefore(errorDiv, field.nextSibling);
            }
            errorDiv.textContent = '此项为必填项';
            errorDiv.style.display = 'block';
          }
        });

        if (!isValid) return;

        // 验证手机号
        const phone = document.getElementById('phone').value;
        const phoneRegex = /^1[3-9]\d{9}$/;
        if (!phoneRegex.test(phone)) {
          alert('请输入正确的手机号码！');
          return;
        }

        // 验证预约人数
        const numPeople = parseInt(document.getElementById('num-people').value);
        if (numPeople < 1 || numPeople > 2) {
          alert('预约人数只能为1或2人');
          return;
        }

        // 提示预约成功
        alert('预约成功！');
        
        // 重置表单
        this.reset();
        
        // 隐藏表单
        document.getElementById('form-container').style.display = 'none';
        
        // 清除选中状态
        document.querySelector('.calendar td.selected')?.classList.remove('selected');
        document.querySelector('.time-slots button.selected')?.classList.remove('selected');
        document.getElementById('time-slots').innerHTML = '<h3>请选择日期查看可预约时间段</h3>';
      });
    });

    generateCalendar(nextMonth);

    // 为所有输入字段添加验证
    document.querySelectorAll('[required]').forEach(field => {
      field.addEventListener('input', function() {
        if (this.value) {
          this.classList.remove('invalid-input');
          const errorDiv = this.nextElementSibling;
          if (errorDiv && errorDiv.classList.contains('error-message')) {
            errorDiv.style.display = 'none';
          }
        }
      });
    });

    // 限制预约人数输入
    document.getElementById('num-people').addEventListener('input', function() {
      const value = parseInt(this.value);
      if (value < 1) this.value = 1;
      if (value > 2) this.value = 2;
    });
  </script>
</body>
</html>
